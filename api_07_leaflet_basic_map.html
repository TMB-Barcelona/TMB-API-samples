<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <title>The TMB-API - Code samples</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        <link rel="icon" href="favicon.ico" type="image/x-icon">

        <link rel="stylesheet" href="styles/53d0747b.vendor.css"/>

        <link rel="stylesheet" href="styles/6f70f11d.main.css"/>

        <!-- Leaflet -->
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    </head>
    <body>
        <!--[if lt IE 10]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <header id="main-menu">
            <div class="navbar navbar-fixed-top navbar-inverse" role="navigation">
                <div class="container">
                    <div class="navbar-header">
                        <!-- Brand and toggle get grouped for better mobile display -->
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="sr-only">Toggle Menu</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="http://tmb-barcelona.github.io/TMB-API-samples/"><img src="images/logoTMB-shadowy.png" title="TMB Developer Portal"></a>
                    </div>
                    <div class="navbar-collapse collapse">

                        <ul class="nav navbar-nav">
                            <!-- Documentació -->

                            <!-- API pública -->

                            <!-- API privada -->

                            <!-- Exemples -->

                            <!-- Cercador -->
                            <!--<li>
                              <a id="search" class="search" title="Cerca" href="https://developer.tmb.cat/search">
                                <i class="icon-search"></i> Cercador
                              </a>
                            </li>-->
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <section class="main-section">

        <div class="container">

            <h2>Basic map with Leaflet</h2>

            <p>This sample shows how to create a very basic map with two raster layers, CARTO SOFT TMB Layer and TMB raster layer but using Leaflet Maps library instead OL3.</p>

			<!-- HERE YOUR HTML e.g.: map, select, button... -->
			
            <div id="map" class="map"></div>
            
            <!-- -->

            <h4 class="text-muted">Source code:</h4>
            <pre><code id="code_text" class="javascript"></code></pre>

            <div class="footer">
                <p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Code samples for The TMB API</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.tmb.cat/" property="cc:attributionName" rel="cc:attributionURL">Transports Metropolitans de Barcelona</a> is derivated from <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Code samples for The Book of OpenLayers3</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/acanimal/thebookofopenlayers3" property="cc:attributionName" rel="cc:attributionURL">Antonio Santiago</a> licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>..</p>
            </div>

        </div>

        </section>

        <!-- Leaflet -->
        <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>



        <script src="scripts/9016e7fe.vendor.js"></script>

        <script src="scripts/6a561692.plugins.js"></script>

        <script src="scripts/87a8dd19.auth.js"></script>



        <!-- Google Analytics -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'Google analytics key', 'auto');
          ga('send', 'pageview');

        </script>
        
        <script>

            /**
             * Ugly but necessary hack.
             * See: https://github.com/Leaflet/Leaflet/issues/1751
              */

            L.TileLayer.WMS = L.TileLayer.extend({

                defaultWmsParams: {
                    service: 'WMS',
                    request: 'GetMap',
                    version: '1.1.1',
                    layers: '',
                    styles: '',
                    format: 'image/jpeg',
                    transparent: false
                },

                initialize: function (url, options) { // (String, Object)

                    this._url = url;

                    var wmsParams = L.extend({}, this.defaultWmsParams),
                            tileSize = options.tileSize || this.options.tileSize;

                    if (options.detectRetina && L.Browser.retina) {
                        wmsParams.width = wmsParams.height = tileSize * 2;
                    } else {
                        wmsParams.width = wmsParams.height = tileSize;
                    }

                    for (var i in options) {
                        // all keys that are not TileLayer options go to WMS params
                        if (!this.options.hasOwnProperty(i) && i !== 'crs') {
                            wmsParams[i] = options[i];
                        }
                    }

                    this.wmsParams = wmsParams;

                    L.setOptions(this, options);
                },

                onAdd: function (map) {

                    this._crs = this.options.crs || map.options.crs;

                    this._wmsVersion = parseFloat(this.wmsParams.version);

                    var projectionKey = this._wmsVersion >= 1.3 ? 'crs' : 'srs';
                    this.wmsParams[projectionKey] = this._crs.code;

                    L.TileLayer.prototype.onAdd.call(this, map);
                },

                getTileUrl: function (tilePoint) { // (Point, Number) -> String

                    var map = this._map,
                            tileSize = this.options.tileSize,

                            nwPoint = tilePoint.multiplyBy(tileSize),
                            sePoint = nwPoint.add([tileSize, tileSize]),

                            nw = this._crs.project(map.unproject(nwPoint, tilePoint.z)),
                            se = this._crs.project(map.unproject(sePoint, tilePoint.z)),
                            bbox = this._wmsVersion >= 1.3 && this._crs === L.CRS.EPSG4326 ?
                                    [se.y, nw.x, nw.y, se.x].join(',') :
                                    [nw.x, se.y, se.x, nw.y].join(','),

                            url = L.Util.template(this._url, {s: this._getSubdomain(tilePoint)});

                    //return url + L.Util.getParamString(this.wmsParams, url, true) + '&BBOX=' + bbox;
                    return url + L.Util.getParamString(this.wmsParams, url, false) + '&BBOX=' + bbox;
                },

                setParams: function (params, noRedraw) {

                    L.extend(this.wmsParams, params);

                    if (!noRedraw) {
                        this.redraw();
                    }

                    return this;
                }
            });

            L.tileLayer.wms = function (url, options) {
                return new L.TileLayer.WMS(url, options);
            };
        	  
        </script>
        
        <script id="code">

            /**
             * This sample needs a little modification in L.TileLayer.WMS (see invisible code in sample)
             * to solve problems with uppercase in TMB authentication
             */

            'use strict';

            var map = L.map('map').setView([41.3987, 2.1574], 12);

            L.tileLayer.wms("http://api.tmb.cat/v1/maps/gwc/wms", {
                'layers': 'TMB:CARTO_SOFT',
                'format': 'image/png',
                'transparent': true,
                'app_key': write_your_app_key_here,
                'app_id': write_your_app_id_here
            }).addTo(map);

            L.tileLayer.wms("http://api.tmb.cat/v1/maps/wms", {
                'layers': 'TMB:XARXA_METRO',
                'format': 'image/png',
                'transparent': true,
                'app_key': write_your_app_key_here,
                'app_id': write_your_app_id_here
            }).addTo(map);
        	
        </script>

        <script>
        	(function() {
        		$('#code_text').text( $('#code').text() );
            	hljs.initHighlightingOnLoad();
        	})();
        </script>

    </body>
</html>
