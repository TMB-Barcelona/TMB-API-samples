<!doctype html>
<html class="no-js">
<head>
    include "head.html"
</head>
<body>
<!--[if lt IE 10]>
<p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->
include "header.html"

<section class="main-section">

    <div class="container">

        <h2>Basic map with WFS petition</h2>

        <p>This sample shows how to create a very basic map with a simple WFS petition load into the map the result from this one.</p>

        <div id="map" class="map"></div>
        <div>
            <label for="show_last_bbox">Show the last BBOX</label>
            <input id="show_last_bbox" type="checkbox">
        </div>
        <div id="info"></div>

        include "text-muted.html"

        include "footer.html"

    </div>

</section>

include "tail.html"

include "ganalytics.html"

<script id="code">

    'use strict';

    var lastExtent = null;

    /**
     * Simple OL3 Map definition with two layers
     *
     * @type {ol.Map}
     */
    var map = new ol.Map({
        layers : [new ol.layer.Tile({
            source : new ol.source.TileWMS({
                params : {
                    'LAYERS' : 'OI.OrthoimageCoverage',
                    'FORMAT' : 'image/png'
                },
                url : 'http://www.ign.es/wms-inspire/pnoa-ma'
            })
        })],
        target : 'map',
        view : new ol.View({
            center : new ol.proj.transform([2.1574, 41.3987], "EPSG:4326", "EPSG:3857"),
            projection : 'EPSG:3857',
            zoom : 16
        })
    });

    /**
     * Function to create the feature list
     *
     * @param response
     */
    var loadData = function(response) {

        var list = document.createElement('ul');

        for (var n in response.features) {
            var feature = response.features[n];
            var li = document.createElement('li');
            li.innerHTML ='<span>' + feature.properties.CODI_ACCES + '-' + feature.properties.NOM_ACCES + '</span>';
            list.appendChild(li);
        };

        var info = document.getElementById('info');

        info.innerHTML = "";
        info.appendChild(list);
    };

    /**
     * Shows the last petition BBOX
     *
     */

    var bboxOverlay = new ol.FeatureOverlay({
        map: map,
        style: new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(255, 255, 255, 0.6)'
            }),
            stroke: new ol.style.Stroke({
                color: '#319FD3',
                width: 1
            })
        })
    });

    var showTheLastBBOX = function(evt) {
        if (evt.currentTarget.checked) {
            var polygonFromExtent = ol.geom.Polygon.fromExtent(lastExtent);
            var featureFromExtent = new ol.Feature({
                geometry: polygonFromExtent,
                name: 'extent'
            });
            bboxOverlay.getFeatures().clear();
            bboxOverlay.addFeature(featureFromExtent);
        } else {
            bboxOverlay.getFeatures().clear();
        }
    };

    var checkShowBBOX = document.getElementById('show_last_bbox');
    checkShowBBOX.addEventListener('click', showTheLastBBOX);

    /**
     * Function to get features
     *
     * @param extent
     * @param resolution
     * @param projection
     */
    var loaderFunction = function(extent, resolution, projection) {
        var url = 'http://api.tmb.cat/v1/maps/wfs?' +
                'app_key=' + write_your_app_key_here +
                '&app_id=' + write_your_app_id_here +
                '&service=WFS&version=1.1.0&request=GetFeature&' +
                'typename=TMB:ACCESSOS' +
                '&outputFormat=application/json&srsname=EPSG:3857&' +
                'bbox=' + extent.join(',') + ',EPSG:3857';

        lastExtent = extent;

        var getFeaturesRequest = new XMLHttpRequest();

        getFeaturesRequest.onreadystatechange = function() {
            if (getFeaturesRequest.readyState != 4 || getFeaturesRequest.status != 200) return;
            var features = getFeaturesRequest.responseText;
            vectorSource.addFeatures(vectorSource.readFeatures(features));
            loadData(JSON.parse(features));
        };
        getFeaturesRequest.overrideMimeType('application/json');
        getFeaturesRequest.open('GET', url, true);

        getFeaturesRequest.send();
    };

    /**
     * Definition of the Vector source
     *
     * @type {ol.source.ServerVector}
     * DEPRECATED: Use Vector instead ServerVector with OL3 v3.5.0
     * See: https://github.com/openlayers/ol3/blob/master/changelog/upgrade-notes.md#new-vector-api
     */
    var vectorSource = new ol.source.ServerVector({
        format : new ol.format.GeoJSON(),
        loader : loaderFunction,
        projection : 'EPSG:3857'
    });


    /**
     * Creation of the Vector layer with the style assigned
     *
     * @type {ol.layer.Vector}
     */
    var vector = new ol.layer.Vector({
        source : vectorSource,
        style : new ol.style.Style({
            image : new ol.style.Circle({
                fill : new ol.style.Fill({
                    color : 'rgba(255,0,0,0.4)'
                }),
                stroke : new ol.style.Stroke({
                    color : '#C90707',
                    width : 3
                }),
                radius : 5
            })
        })
    });

    map.addLayer(vector);

</script>

include "sourcecode.html"

</body>
</html>
