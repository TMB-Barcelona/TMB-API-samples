<!doctype html>
<html class="no-js">
<head>
    <meta charset="utf-8">
    <title>The TMB-API - Code samples</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="styles/a2844004.vendor.css"/>

    <!-- bootswatch yeti theme -->
    <link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/yeti/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="styles/2da05352.main.css"/>

    <!-- OpenLayers -->
    <link rel="stylesheet" href="http://ol3js.org/en/master/css/ol.css">
</head>
<body>
<!--[if lt IE 10]>
<p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->

<div class="container">

    <div class="header">
    	
        <h1><a href="index.html">The TMB - API <span class="text-muted">[Code samples]</span></a></h1>

        <p>These are the code samples for <a href="https://developer.tmb.cat/">The TMB API</a>.

        <div>

        </div>
    </div>

    <h2>Playing with Time as variable</h2>

    <p>The page reloading itself every 10 seconds loading new data</p>

    <div id="map" class="map"></div>

    <div class="btn-group" role="group" aria-label="...">
        <button id="stop" type="button" class="btn btn-default">Stop</button>
        <button id="play" type="button" class="btn btn-default">Play</button>
        <!--button type="button" class="btn btn-default">Right</button-->
    </div>
    <!-- -->

    <h4 class="text-muted">Source code:</h4>
    <pre><code id="code_text" class="javascript"></code></pre>

    <div class="footer">
        <p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Code samples for The TMB API</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.tmb.cat/" property="cc:attributionName" rel="cc:attributionURL">Transports Metropolitans de Barcelona</a> is derivated from <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Code samples for The Book of OpenLayers3</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/acanimal/thebookofopenlayers3" property="cc:attributionName" rel="cc:attributionURL">Antonio Santiago</a> licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>..</p>
    </div>

</div>

<!-- OpenLayers -->
<script src="http://ol3js.org/en/master/build/ol.js"></script>

<script src="scripts/9016e7fe.vendor.js"></script>

<script src="scripts/c6b52431.plugins.js"></script>

<script src="scripts/87a8dd19.auth.js"></script>



<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'Google analytics key', 'auto');
  ga('send', 'pageview');

</script>

<script id="code">

    var baseLayer = new ol.layer.Tile({
        style: 'Road',
        source: new ol.source.MapQuest({layer: 'osm'})
    });

    var map = new ol.Map({
        layers: [
            baseLayer
        ],
        target: 'map',
        view: new ol.View({
            center: new ol.proj.transform([2.1574, 41.3987], "EPSG:4326", "EPSG:3857"),
            projection: 'EPSG:3857',
            zoom: 16
        })
    });

    var nameLayer = 'TMB:PARADES_ACTIVES';
    var intervalID = 0;
    var intervalFunc = null;

    var onPlay = function() {
        intervalFunc();
        intervalID = setInterval(intervalFunc, 10000);
    };

    var onStop = function() {
        clearInterval(intervalID);
        intervalID = 0;
    };

    document.getElementById('stop').addEventListener('click', onStop);
    document.getElementById('play').addEventListener('click', onPlay);

    /**
     * Function to get features
     * @param extent
     * @param resolution
     * @param projection
     */
    var loaderFunction = function() {
        var url = 'http://api.tmb.cat/v1/maps/wfs?app_key=' + write_your_app_key_here +
                '&app_id=' + write_your_app_id_here +
                '&service=WFS&version=1.1.0&request=GetFeature&' +
                'typename=' +  nameLayer +
                '&outputFormat=application/json&srsname=EPSG:3857';

        var getFeaturesRequest = new XMLHttpRequest();

        getFeaturesRequest.onreadystatechange = function() {
            if (getFeaturesRequest.readyState != 4 || getFeaturesRequest.status != 200) return;
            loadFeatures(JSON.parse(getFeaturesRequest.responseText));
        };
        getFeaturesRequest.overrideMimeType('application/json');

        intervalFunc = function() {
            getFeaturesRequest.open('GET', url, true);
            getFeaturesRequest.send();
        };
        if (intervalID === 0) {
            intervalFunc();
            intervalID = setInterval(intervalFunc, 10000);
        }
    };

    /**
     *
     * @type {ol.source.ServerVector}
     */
    var vectorSource = new ol.source.ServerVector({
        format : new ol.format.GeoJSON(),
        loader : loaderFunction,
        projection : 'EPSG:3857',
        strategy: ol.loadingstrategy.all
    });

    /**
     *
     * @param response
     */
    var loadFeatures = function(response) {
        vectorSource.clear(true);
        vectorSource.addFeatures(vectorSource.readFeatures(response));
    };

    /**
     *
     * @type {ol.layer.Vector}
     */
    var vector = new ol.layer.Vector({
        source : vectorSource,
        style : new ol.style.Style({
            image : new ol.style.Circle({
                fill : new ol.style.Fill({
                    color : 'rgba(255,0,0,0.4)'
                }),
                stroke : new ol.style.Stroke({
                    color : '#C90707',
                    width : 3
                }),
                radius : 5
            })
        })
    });

    map.addLayer(vector);

</script>

<script>
	(function() {
		$('#code_text').text( $('#code').text() );
    	hljs.initHighlightingOnLoad();
	})();
</script>

</body>
</html>
