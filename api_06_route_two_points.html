<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <title>The TMB-API - Code samples</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        <link rel="icon" href="favicon.ico" type="image/x-icon">

        <link rel="stylesheet" href="styles/a2844004.vendor.css"/>

        <!-- bootswatch yeti theme -->
        <link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/yeti/bootstrap.min.css" rel="stylesheet">

        <link rel="stylesheet" href="styles/6f70f11d.main.css"/>

        <!-- OpenLayers -->
        <link rel="stylesheet" href="http://ol3js.org/en/master/css/ol.css">
    </head>
    <body>
        <!--[if lt IE 10]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <header id="main-menu">
            <div class="navbar navbar-fixed-top navbar-inverse" role="navigation">
                <div class="container">
                    <div class="navbar-header">
                        <!-- Brand and toggle get grouped for better mobile display -->
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="sr-only">Toggle Menu</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/"><img src="images/logoTMB-shadowy.png" title="TMB Developer Portal"></a>
                    </div>
                    <div class="navbar-collapse collapse">

                        <ul class="nav navbar-nav">
                            <!-- Documentació -->

                            <!-- API pública -->

                            <!-- API privada -->

                            <!-- Exemples -->

                            <!-- Cercador -->
                            <!--<li>
                              <a id="search" class="search" title="Cerca" href="https://developer.tmb.cat/search">
                                <i class="icon-search"></i> Cercador
                              </a>
                            </li>-->
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <section class="main-section">

        <div class="container">

            <h2>Calculate route between two points</h2>

            <p> Calculate route between two points using TMB Planner API.
                Click one time to set start place. Click two times to set stop place, Click one more time to remove all markers and the route and start again.</p>

			<!-- HERE YOUR HTML e.g.: map, select, button... -->
			
            <div id="map" class="map"></div>
            
            <!-- -->

            <h4 class="text-muted">Source code:</h4>
            <pre><code id="code_text" class="javascript"></code></pre>

            <div class="footer">
                <p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Code samples for The TMB API</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.tmb.cat/" property="cc:attributionName" rel="cc:attributionURL">Transports Metropolitans de Barcelona</a> is derivated from <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Code samples for The Book of OpenLayers3</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/acanimal/thebookofopenlayers3" property="cc:attributionName" rel="cc:attributionURL">Antonio Santiago</a> licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>..</p>
            </div>

        </div>

        </section>

        <!-- OpenLayers -->
        <script src="http://ol3js.org/en/master/build/ol.js"></script>

        <script src="scripts/9016e7fe.vendor.js"></script>

        <script src="scripts/c6b52431.plugins.js"></script>

        <script src="scripts/87a8dd19.auth.js"></script>



        <!-- Google Analytics -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'Google analytics key', 'auto');
          ga('send', 'pageview');

        </script>
        
        <script>
        
        	 var images = {
                 start: 'images/start.png',
                 stop: 'images/stop.png'
             };
        	  
        </script>
        
        <script id="code">

            var layers = [
                new ol.layer.Tile({
                    source: new ol.source.TileWMS({
                        params: {
                            'LAYERS': 'TMB:CARTO_SOFT',
                            'FORMAT': 'image/png',
                            'srs': 'EPSG:3857',
                            'app_key': write_your_app_key_here,
                            'app_id': write_your_app_id_here
                        },
                        url: 'http://api.tmb.cat/v1/maps/gwc/wms'
                    })
                })
            ];

            /**
             * Source to save markers
             * @type {ol.source.Vector}
             */
            var markers = new ol.source.Vector();

            /**
             * Source to save the route
             * @type {ol.source.Vector}
             */
            var routes = new ol.source.Vector();

            /**
             * Layer to save markers using source
             * @type {ol.layer.Vector}
             */
            var vectorLayer = new ol.layer.Vector({
                source: markers
            });

            /**
             * Layer to save route using the route source.
             * The style is aplied
             * @type {ol.layer.Vector}
             */
            var routeLayer = new ol.layer.Vector({
                source: routes,
                style : new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: [0, 153, 255, 1],
                        width: 3
                    })
                })
            });

            layers.push(vectorLayer, routeLayer);

            var map = new ol.Map({
                layers: layers,
                target: 'map',
                view: new ol.View({
                    center: new ol.proj.transform([2.1574, 41.3987], "EPSG:4326", "EPSG:3857"),
                    projection: 'EPSG:3857',
                    zoom: 12
                })
            });

            map.on('click', function(evt) {

                var geom = new ol.geom.Point(
                        evt.coordinate
                );

                var marker = new ol.Feature(geom);

                var howMannyMarkers = markers.getFeatures().length;
                if (howMannyMarkers == 0) {
                    var icon = new ol.style.Icon({
                        src: images.start
                    });
                    marker.setId('start');
                } else if (howMannyMarkers == 1) {
                    var icon = new ol.style.Icon({
                        src: images.stop
                    });
                    marker.setId('stop');
                }

                if (howMannyMarkers == 0 || howMannyMarkers == 1) {
                    var iconStyle = new ol.style.Style({
                        image : icon
                    });
                    marker.setStyle(iconStyle);
                    markers.addFeature(marker);
                } else {
                    markers.clear(true);
                    routes.clear(true);
                }

                if (markers.getFeatures().length == 2) {
                    var api = 'http://api.tmb.cat/v1/planner/plan?';
                    var start = markers.getFeatureById('start');
                    var stop = markers.getFeatureById('stop');

                    var url = api + 'app_key=' + write_your_app_key_here +
                                    '&app_id=' + write_your_app_id_here;

                    var fromPlace = start.getGeometry().clone().transform('EPSG:3857', 'EPSG:4326').getCoordinates();
                    var toPlace = stop.getGeometry().clone().transform('EPSG:3857', 'EPSG:4326').getCoordinates();

                    url = url + '&fromPlace=' + ol.coordinate.format(fromPlace, '{y},{x}', 18) +
                            '&toPlace=' + ol.coordinate.format(toPlace, '{y},{x}', 18);

                    var getPlanRequest = new XMLHttpRequest();

                    getPlanRequest.onreadystatechange = function() {
                        if (getPlanRequest.readyState != 4 || getPlanRequest.status != 200) return;
                        var response = JSON.parse(getPlanRequest.response);
                        var plan = response.plan;
                        var itinerary = plan.itineraries[0];
                        for (var n in itinerary.legs) {
                            var leg = itinerary.legs[n];
                            /**
                             * We need to dedode polyline to create the linestring geometry
                             * https://github.com/openlayers/ol3/blob/v3.3.0/src/ol/format/polylineformat.js
                             */
                            var legGeom = ol.format.Polyline.decodeDeltas(leg.legGeometry.points, 2);
                            /**
                             * To create the linestring geometry it is necessary reorder the geoms
                             * obtained from the decoding in an array of coordinates
                             */
                            var coordinates = [];
                            for (var n= 0; n<legGeom.length - 1; n=n+2) {
                                coordinates.push([legGeom[n + 1], legGeom[n]]);
                            }
                            var geom = new ol.geom.LineString(coordinates);
                            var route = new ol.Feature(geom.transform('EPSG:4326', 'EPSG:3857'));
                            routes.addFeature(route);
                        }
                    };
                    getPlanRequest.overrideMimeType('application/json');
                    getPlanRequest.open('GET', url, true);
                    getPlanRequest.send();
                }
            });

        </script>

        <script>
        	(function() {
        		$('#code_text').text( $('#code').text() );
            	hljs.initHighlightingOnLoad();
        	})();
        </script>

    </body>
</html>
