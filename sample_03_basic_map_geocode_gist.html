<!doctype html>
<html class="no-js">
<head>
    <meta charset="utf-8">
    <title>The TMB-API - Code samples</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="styles/f3167c1a.vendor.css"/>

    <!-- bootswatch yeti theme -->
    <link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/yeti/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="styles/3c6c5ed2.main.css"/>

    <!-- OpenLayers -->
    <link rel="stylesheet" href="http://ol3js.org/en/master/css/ol.css">
</head>
<body>
<!--[if lt IE 10]>
<p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->

<div class="container">

    <div class="header">
    	
        <h1><a href="index.html">The TMB - API <span class="text-muted">[Code samples]</span></a></h1>

        <p>These are the code samples for <a href="https://developer.tmb.cat/">The TMB API</a>.

        <div>

        </div>
    </div>

    <h2>Map with WFS + WMS chainned calls</h2>

    <p>This sample shows how to "go and filter" a WMS layer based on data retrieved from a WFS petition.</p>

    <div id="map" class="map"></div>

    <select id="selectfeatures">
        <option value="0">LINIA - NOM</option>
    </select>

    <h4 class="text-muted">Source code:</h4>
    <pre><code id="code_text" class="javascript"></code></pre>

    <div class="footer">
        <p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Code samples for The TMB API</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.tmb.cat/" property="cc:attributionName" rel="cc:attributionURL">Transports Metropolitans de Barcelona</a> is derivated from <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Code samples for The Book of OpenLayers3</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/acanimal/thebookofopenlayers3" property="cc:attributionName" rel="cc:attributionURL">Antonio Santiago</a> licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>..</p>
    </div>

</div>

<script src="scripts/e178cc81.vendor.js"></script>

<script src="scripts/c6b52431.plugins.js"></script>

<script src="scripts/87a8dd19.auth.js"></script>

<!-- OpenLayers -->
<script src="http://ol3js.org/en/master/build/ol.js"></script>

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'Google analytics key', 'auto');
  ga('send', 'pageview');

</script>

<script id="code">

    'use strict';

    var selectedIndex = 0;

    var features = [];

    var baseLayer = new ol.layer.Tile({
        source: new ol.source.TileWMS({
            params: {
                'LAYERS': 'OI.OrthoimageCoverage',
                'FORMAT': 'image/png'
            },
            url: 'http://www.ign.es/wms-inspire/pnoa-ma'
        })
    });

	// split layer source definition in order to change layer filter dinamically later on.
    var xarxa_metro_source = new ol.source.TileWMS({
        params: {
            'LAYERS': 'TMB:XARXA_METRO',
            'FORMAT': 'image/png',
            'app_key': write_your_app_key_here,
            'app_id': write_your_app_id_here
        },
        url: 'http://api.tmb.cat/v1/maps/wms'
    });

    var overlayLayer = new ol.layer.Tile({
        source: xarxa_metro_source
    });

    var layers = [
        baseLayer, overlayLayer
    ];

    var map = new ol.Map({
        layers: layers,
        target: 'map',
        view: new ol.View({
            center: new ol.proj.transform([2.1574, 41.3987], "EPSG:4326", "EPSG:3857"),
            projection: 'EPSG:3857',
            zoom: 13
        })
    });

    /**
     * Function to get features: Linies Metro combobox
     * @param callback, function receives the response
     */
    var getDataFeatures = function(callback) {
        var url = 'http://api.tmb.cat/v1/maps/wfs?' + 
                'app_key=' + write_your_app_key_here +
                '&app_id=' + write_your_app_id_here +
                '&service=WFS&version=1.1.0&request=GetFeature' +
				'&sortBy=CODI_LINIA' +
                '&typename=TMB:LINIES_METRO' +
                '&outputFormat=application/json&srsname=EPSG:3857';

        var getFeaturesRequest = new XMLHttpRequest();

        getFeaturesRequest.onreadystatechange = function() {
            if (getFeaturesRequest.readyState != 4 || getFeaturesRequest.status != 200) return;
            callback(JSON.parse(getFeaturesRequest.responseText));
        };
        getFeaturesRequest.overrideMimeType('application/json');
        getFeaturesRequest.open('GET', url, true);

        getFeaturesRequest.send();
    };

    var select = document.getElementById('selectfeatures');

	// Combo click event: Center + Filter info
    var onClickSelector = function(evt) {

        var codi_linia = evt.currentTarget.selectedOptions[selectedIndex].value;
        var bbox = null;

        if (codi_linia === '0') {
            return;
        }

        for (var n in features) {
            var feature = features[n]
            if (feature.properties['CODI_LINIA'] == codi_linia) {
                var geom;
                if (feature.geometry.type == 'LineString') {
                    geom = new ol.geom.LineString(feature.geometry.coordinates);
                } else if (feature.geometry.type == 'MultiLineString') {
                    geom = new ol.geom.MultiLineString(feature.geometry.coordinates);
                }
                bbox = geom.getExtent();
                break;
            }
        }

        xarxa_metro_source.updateParams({
            'CQL_FILTER': 'CODI_LINIA=' + codi_linia,
            'BBOX': bbox.join(',')
        });

        map.getView().fitExtent(bbox, map.getSize());
    };

    select.addEventListener('change', onClickSelector);

    /**
     * Function to load data from WFS into HTML Select control
     * @param response
     */
    var loadData = function(response) {
        features = response.features;
        for (var n in features) {
            var feature = features[n];
            select.appendChild(new Option(feature.properties.NOM_LINIA + ' - ' + feature.properties.DESC_LINIA, feature.properties.CODI_LINIA));
        }
    };

	// load select control on load
    getDataFeatures(loadData);

</script>

<script>
	(function() {
		$('#code_text').text( $('#code').text() );
    	hljs.initHighlightingOnLoad();
	})();
</script>

</body>
</html>
